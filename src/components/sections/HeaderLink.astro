---
import type { HTMLAttributes } from 'astro/types';

type Props = HTMLAttributes<'a'> & {
  exact?: boolean;        // when true, only exact matches are active
  external?: boolean;     // when true, force external link behavior (target, rel)
};

const {
  href = '/',
  class: className,
  exact = false,
  external,
  ...props
} = Astro.props as Props;

// Normalize helper: strip base, ensure leading slash, drop trailing slash except root
const normalize = (p: string) => {
  try {
    if (/^https?:\/\//i.test(p)) p = new URL(p).pathname;
  } catch {
    // Fallback keep original if URL parsing fails
  }

  const base = import.meta.env.BASE_URL || '/';
  if (base !== '/' && p.startsWith(base)) p = '/' + p.slice(base.length);

  if (!p.startsWith('/')) p = '/' + p;
  if (p.length > 1 && p.endsWith('/')) p = p.slice(0, -1);
  return p;
};

const currentPath = normalize(Astro.url.pathname || '/');
const linkPath = normalize(String(href || '/'));

const segs = currentPath.split('/').filter(Boolean);
const sectionPath = segs.length ? `/${segs[0]}` : '/';

const isActive = exact ? (linkPath === currentPath) : (linkPath === currentPath || linkPath === sectionPath);
const ariaCurrent = isActive ? 'page' : undefined;

const isExternal = typeof external === 'boolean'
  ? external
  : /^https?:\/\//i.test(String(href));
---

<a
  href={href}
  aria-current={ariaCurrent}
  class:list={[
    'header-link',
    className,
    { active: isActive }
  ]}
  {...(isExternal ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
  {...props}
>
  <slot />
</a>

<style>
  .header-link {
    display: inline-block;
    text-decoration: none;
    color: var(--foreground);
    opacity: 0.85;
    transition: color 0.2s ease, opacity 0.2s ease, text-decoration-thickness 0.2s ease;
  }
  .header-link:hover, .header-link:focus-visible {
    color: var(--accent);
    opacity: 1;
    outline: none;
  }
  .header-link.active {
    color: var(--accent);
    font-weight: 700;
    text-decoration: underline;
    text-underline-offset: 4px;
    text-decoration-thickness: 2px;
  }
</style>
